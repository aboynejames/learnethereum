 <html>
<head>
	<title>JavaScript API</title>
	<script src="js/web3.min.js" type="text/javascript"></script>
	<script src='js/bignumber.js'></script>
	<script src='js/jquery-2.0.3.min.js'></script>
  
  
	<link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css">
	<link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js">
  
<script type="text/javascript">
/**
*  jQuery listen for clicks and interaction	
* 
*   instructions
*    install ethereum  PPA dev release used https://github.com/ethereum/cpp-ethereum/wiki/Installing%20Clients 
*   start up ethereum client e.g. eth -j --json-rpc-port 8545 -i
*   starts client in interactive mode
* 
* 
*  A   send either 
*   1a  fill in online form with address of known ethereum account  and amount of ether
*   2a  click send
*   3a  minestart  on command line and then minestop
* 
* 
*  B
*  1b  creates a new smart contract, https://dappsforbeginners.wordpress.com/tutorials/javascript-api-2/  based on this example (ie updated for JS api use and adds read balance function to contract
*  2b  Click on Click  Create Solidity Coin Contract
*  3b  minestart on command line  then command  minestop
*  4b the watch function will show true once the contract has been accepted on the blockchain
*  5b  enter a known public ethereum address into the Send some coins form and an amount
*  6b  click send
*  7b at command line    minestart    and then  minestop
*  
*  C
*   1c  click on the view balance  NB make sure the code has the public address used above.
*   2c  the new balance is shown in console.
*/	
$(document).ready(function(){

 	var web3 = require('web3');
console.log(web3);	
	web3.setProvider(new web3.providers.HttpProvider("http://localhost:8545"));
 console.log(web3);  
 		// let's assume that coinbase is our account
		web3.eth.defaultAccount = 'cfa942ba595fffa0be0946a3f18dbe68b325e56e'; //web3.eth.coinbase;
console.log(web3.eth.coinbase);
  
  	var balether =web3.fromWei(web3.eth.getBalance('cfa942ba595fffa0be0946a3f18dbe68b325e56e'), "ether")
console.log(balether + 'ether in account');

	var gasPrice = web3.eth.gasPrice;
console.log(gasPrice.toString(10));
  
	var mysendcoin;
	
console.log($('#recipient').val());	
console.log($('#value').val());	

	$("#sendether").click(function(e) {
		e.preventDefault(e);
		
console.log($('#recipient').val());	
console.log($('#value').val());	
		idclick = $(this).attr("id");
//		var code ="603d80600c6000396000f3007c01000000000000000000000000000000000000000000000000000000006000350463c6888fa18114602d57005b6007600435028060005260206000f3";

		web3.eth.sendTransaction({to: $('#recipient').val() ,value: $('#value').val()}, function(err, address) {
		  if (!err)
		  {
console.log(address); // "0x7f9fade1c0d57a7af66ab4ead7c2eb7b11a91385"
		  
		  }
		  else
		  {
console.log(err);		  
		  }
		  
		});
				
	});
	
	
	$("#createSolidityContract").click(function(e) {
	
		e.preventDefault(e);
		idclick = $(this).attr("id");

		//contract source code
		var soliditySource = "contract metaCoin {\n"+
			" mapping (address => uint) public balances;\n" +
			" function metaCoin() {\n" +
			" balances[msg.sender] = 190000;\n" +
			" balances[0x96db605d537d33847842a8f94f5473af9dd0a746] = 8000;\n" +
			" }\n" +
			" function sendCoin(address receiver, uint amount) returns(bool successful) {\n" +
			" if (balances[msg.sender] < amount) return false;\n" +
			" balances[msg.sender] -= amount;\n" +
			" balances[receiver] += amount;\n" +
			" return true;\n" +
			" }\n" +
			" function multiply(uint a) constant returns(uint d) {\n" +
			"       return a * 7;\n" +
			"   }\n" +
			" function showbalance(address receiver) constant returns(uint d) {\n" +
			"       return balances[receiver];\n" +
			"   }\n" +		
			"}";
		//contract abi object
		var compiled = web3.eth.compile.solidity(soliditySource);
console.log(compiled);
		var code = compiled.metaCoin.code;
console.log(code);   
		// contract json abi, this is autogenerated using solc CLI
		var abi = compiled.metaCoin.info.abiDefinition;
console.log('abi list');	
console.log(abi);
		
		// filter oject watching last blocks mined
		var watchblocks = web3.eth.filter('latest');
console.log(watch);

		// create a new contract
		web3.eth.contract(abi).new({data: code, gas: 300000,}, function (err, contract) {
			if (err) {
console.error(err);
				return;
			}
			$('#status').text("transaction sent, waiting for confirmation");
		
			mysendcoin = contract;
console.log('address: ' + mysendcoin.address);
console.log('yes mined and ready for use');
        });



/*
		watchblocks.watch(function (err, hash) {
console.log(hash);		
			var block = web3.eth.getBlock(hash, true); 
console.log(block);		    
			var contractMined = block.transactions.reduce(function (mined, th) {
console.log(mined);
console.log(th);
console.log(th.from);
console.log(web3.eth.defaultAccount);
console.log(th.input.indexOf(code));
				// TODO: compiled code do not have 0x prefix
				return mined || (th.from === web3.eth.defaultAccount && th.input.indexOf(code) !== -1);
				}, false);
console.log(contractMined);
			});
*/				
	});
	
	/*
	*  transfer amount from sender to another public key account
	*
	*/
	$("#dataTransaction").click(function(e) {

		var receiverAddress = $('#receiverAddress').val();
		var amount = $('#amount').val();
console.log(receiverAddress);
console.log(amount);
		var returnmybalance = mysendcoin;
console.log(returnmybalance);
		var returnmessage = mysendcoin.sendCoin(receiverAddress, amount);
console.log(returnmessage);

		var res = mysendcoin.multiply(11);
console.log(res);	
console.log(web3.toDecimal(res));

	});
	
	/**
	*  check balance of accounts
	*/
	$("#viewbalance").click(function(e) {
	
		var showballive = mysendcoin.showbalance("0x96db605d537d33847842a8f94f5473af9dd0a746");  // need to add public key know to you, ie please edit.
console.log(showballive);	
console.log(web3.toDecimal(showballive));
		var balupdate = "new balance == " + web3.toDecimal(showballive);
		$("#newbalance").text(balupdate);
	});

}); // closes jquery
</script>

</head>

<body>
	<div>
		<div>
			<h3>Transact Example</h3>
		</div>
		<div>
			<input id="recipient" type="text" placeholder="To">
			<input id="value" type="text" placeholder="Value in Wei">
		</div>
		<div>
			<button id="sendether">Send Ether</button>
		</div>
		<div>
			Put in addresses prefixed with '0x' and hit 'Send transaction'
		</div>
		
		
		<div>
			<h3>Create a contract</h3>
		</div>
		<div>
			<button id="createSolidityContract">Create Solidity Coin Contract</button>
		</div>
		<div>
			<h3>Send some coins</h3>
		</div>
		<div>
			<input id="receiverAddress" class="form-control" type="text" placeholder="Receiver address"></input><br>
			<input id="amount" class="form-control" type="text" placeholder="Amount"></input><br>
		</div>
		<button id="dataTransaction">Send transaction</button>
		<p>
			<button id="viewbalance">View latest balance</button><div id="newbalance"></div>

		</p>
	</div>
	
</body>
</html>
